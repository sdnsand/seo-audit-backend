import * as React from "react"
import { addPropertyControls, ControlType } from "framer"
import { jsPDF } from "jspdf"

export default function SeoAuditTool(props) {
    // --- STATE ---
    const [url, setUrl] = React.useState("")
    const [email, setEmail] = React.useState("")
    const [consent, setConsent] = React.useState(false)
    const [loading, setLoading] = React.useState(false)
    const [report, setReport] = React.useState(null)
    const [error, setError] = React.useState("")
    const [theme, setTheme] = React.useState("dark")

    // --- ACTIONS ---
    const toggleTheme = () => setTheme(prev => prev === "dark" ? "light" : "dark")

    const runAudit = async () => {
        if (!url) return setError("Please enter a website URL")
        if (!consent) return setError("Please consent to data processing")
        
        let cleanUrl = url.trim()
        if (!cleanUrl.startsWith("http")) cleanUrl = "https://" + cleanUrl

        setLoading(true); setError(""); setReport(null)

        try {
            // Remove trailing slash from backend URL if present
            const backend = props.backendUrl.replace(/\/$/, "")
            
            const res = await fetch(`${backend}/api/audit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: cleanUrl, email }),
            })

            // Handle server waking up (common on free tier)
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server is waking up. Please try again in 30 seconds.");
            }

            const data = await res.json()
            if (!res.ok) throw new Error(data.error || "Audit failed")
            setReport(data)
        } catch (err) {
            setError(err.message)
        } finally {
            setLoading(false)
        }
    }

    const downloadPDF = () => {
        if (!report) return
        const doc = new jsPDF()
        let y = 20
        
        doc.setFontSize(22); doc.setTextColor(37, 99, 235)
        doc.text("SEO Audit Report", 20, y); y += 15
        
        doc.setFontSize(11); doc.setTextColor(0, 0, 0)
        doc.text(`Target: ${report.url}`, 20, y); y += 7
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y); y += 7
        doc.text(`Score: ${report.report.health_score}/100`, 20, y); y += 15

        doc.setFontSize(14); doc.text("Executive Summary:", 20, y); y += 10
        doc.setFontSize(10)
        const summary = doc.splitTextToSize(report.report.summary, 170)
        doc.text(summary, 20, y); y += (summary.length * 5) + 15

        doc.setFontSize(14); doc.text("Top Actions:", 20, y); y += 10
        report.report.recommendations.forEach(rec => {
            if(y > 270) { doc.addPage(); y = 20; }
            doc.setFontSize(11); doc.setFont("helvetica", "bold")
            doc.text(`[${rec.priority}] ${rec.issue}`, 20, y); y += 6
            doc.setFont("helvetica", "normal"); doc.setFontSize(10)
            const fix = doc.splitTextToSize(`Fix: ${rec.fix}`, 170)
            doc.text(fix, 20, y); y += (fix.length * 5) + 8
        })
        doc.save(`audit-${new URL(report.url).hostname}.pdf`)
    }

    // --- HELPER COMPONENTS ---
    const MetricBox = ({ label, value }) => (
        <div className="metric-item">
            <div className="metric-value">{value}</div>
            <div className="metric-label">{label}</div>
        </div>
    )

    const DetailRow = ({ label, value, status }) => (
        <div className="metric-detail">
            <div className="metric-detail-label">{label}</div>
            <div className={`metric-detail-value ${status === 'good' ? 'status-good' : status === 'error' ? 'status-error' : ''}`}>{value}</div>
        </div>
    )

    return (
        <div className="seo-root" data-theme={theme}>
            <style>{cssStyles}</style>

            <button className="theme-toggle" onClick={toggleTheme}>
                {theme === "dark" ? "‚òÄÔ∏è" : "üåô"}
            </button>

            <div className="container">
                <div className="header">
                    <h1>üöÄ Free AI SEO Audit Tool</h1>
                    <div className="trust-badges">
                        <span>‚úÖ Free</span><span>ü§ñ AI Powered</span><span>üîí Secure</span>
                    </div>
                </div>

                <div className="input-card">
                    <div className="form-row">
                        <div className="input-group">
                            <label>Website URL *</label>
                            <input type="text" placeholder="https://example.com" value={url} onChange={e => setUrl(e.target.value)} />
                        </div>
                        <div className="input-group">
                            <label>Email (Optional)</label>
                            <input type="email" placeholder="report@email.com" value={email} onChange={e => setEmail(e.target.value)} />
                        </div>
                    </div>
                    <div className="checkbox-group">
                        <input type="checkbox" checked={consent} onChange={e => setConsent(e.target.checked)} />
                        <label>I consent to data processing for this audit.</label>
                    </div>
                    {error && <div className="error-banner">{error}</div>}
                    <button className="audit-btn" onClick={runAudit} disabled={loading}>
                        {loading ? "‚è≥ Analyzing (Wait ~30s)..." : "üîç Run Audit"}
                    </button>
                </div>

                {loading && (
                    <div className="loader">
                        <div className="loader-spinner"></div>
                        <div className="loader-text">Scanning site & generating report...</div>
                    </div>
                )}

                {report && !loading && (
                    <div className="results-container">
                        <div className="results-header">
                            <h2>üìä Audit Results</h2>
                            <small>{report.domain} ‚Ä¢ {new Date(report.timestamp).toLocaleDateString()}</small>
                        </div>

                        <div className="grid">
                            {/* SCORE */}
                            <div className="card text-center">
                                <h3>Health Score</h3>
                                <div className="score-big" style={{
                                    background: `conic-gradient(${report.report.health_score >= 80 ? '#10b981' : report.report.health_score >= 50 ? '#f59e0b' : '#ef4444'} ${report.report.health_score * 3.6}deg, var(--border) 0deg)`
                                }}>
                                    <div className="score-inner">{report.report.health_score}</div>
                                </div>
                            </div>

                            {/* METRICS */}
                            <div className="card">
                                <h3>üìà Key Metrics</h3>
                                <div className="metric-grid">
                                    <MetricBox label="Speed" value={report.metrics.performance} />
                                    <MetricBox label="SEO" value={report.metrics.seo} />
                                    <MetricBox label="Mobile" value={report.metrics.mobileScore} />
                                    <MetricBox label="Tech" value={report.metrics.technical?.performance || 80} />
                                </div>
                            </div>

                            {/* CONTENT */}
                            <div className="card">
                                <h3>üìù Content Stats</h3>
                                <div className="metric-grid">
                                    <MetricBox label="H1 Tags" value={report.structure.h1Count} />
                                    <MetricBox label="Missing Alt" value={report.structure.images.missingAlt} />
                                    <MetricBox label="Words" value={report.structure.wordCount} />
                                    <MetricBox label="Readability" value={report.structure.readabilityScore} />
                                </div>
                            </div>
                        </div>

                        {/* TECH DEEP DIVE */}
                        <div className="card mt-30">
                            <h3>üîß Technical Deep Dive</h3>
                            <div className="metrics-grid">
                                <DetailRow label="LCP Speed" value={report.metrics.technical.largestContentfulPaint?.displayValue || "N/A"} />
                                <DetailRow label="SSL Secure" value={report.metrics.security?.httpsUsed ? "Yes" : "No"} status={report.metrics.security?.httpsUsed ? "good" : "error"} />
                                <DetailRow label="Robots.txt" value={report.structure.robotsTxt?.exists ? "Found" : "Missing"} status={report.structure.robotsTxt?.exists ? "good" : "error"} />
                                <DetailRow label="Sitemap" value={report.structure.sitemap?.found ? "Found" : "Missing"} status={report.structure.sitemap?.found ? "good" : "error"} />
                            </div>
                        </div>

                        {/* SOCIAL & KEYWORDS */}
                        <div className="grid mt-30">
                            <div className="card">
                                <h3>üîë Top Keywords</h3>
                                <div className="tags">
                                    {report.structure.keywordAnalysis?.topKeywords?.slice(0, 6).map((kw, i) => (
                                        <span key={i} className="tag">{kw.word} ({kw.density}%)</span>
                                    ))}
                                </div>
                            </div>
                            <div className="card">
                                <h3>üåê Social Graph</h3>
                                <DetailRow label="OG Title" value={report.structure.openGraph?.found ? "Found" : "Missing"} status={report.structure.openGraph?.found ? "good" : "error"} />
                                <DetailRow label="Twitter Card" value={report.structure.openGraph?.twitter?.card ? "Present" : "Missing"} status={report.structure.openGraph?.twitter?.card ? "good" : "error"} />
                            </div>
                        </div>

                        {/* AI SUMMARY */}
                        <div className="card mt-30">
                            <h3>ü§ñ AI Executive Summary</h3>
                            <p style={{lineHeight: 1.6, opacity: 0.9}}>{report.report.summary}</p>
                        </div>

                        {/* RECOMMENDATIONS */}
                        <div className="mt-40">
                            <h3>üéØ Action Plan</h3>
                            {report.report.recommendations.map((rec, i) => (
                                <div key={i} className={`rec-item rec-${rec.priority.toLowerCase().replace(' ', '-')}`}>
                                    <div className="rec-header">
                                        <strong>{rec.issue}</strong>
                                        <span className={`badge badge-${rec.priority.toLowerCase().replace(' ', '-')}`}>{rec.priority}</span>
                                    </div>
                                    <div className="rec-fix">üí° {rec.fix || rec.how_to_fix}</div>
                                </div>
                            ))}
                        </div>

                        <div className="action-buttons">
                            <button className="btn-secondary" onClick={downloadPDF}>üìÑ Download Report</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    )
}

addPropertyControls(SeoAuditTool, {
    backendUrl: {
        type: ControlType.String,
        title: "Backend URL",
        defaultValue: "https://seo-audit-backend-g6u3.onrender.com",
        placeholder: "https://seo-audit-backend-g6u3.onrender.com"
    },
})

const cssStyles = `
    [data-theme="light"] { --primary: #2563eb; --bg: #f8fafc; --card: #fff; --text: #1e293b; --border: #e2e8f0; }
    [data-theme="dark"] { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; }
    
    .seo-root { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; width: 100%; transition: 0.3s; box-sizing: border-box; }
    .container { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { margin: 0; color: var(--primary); font-size: 2rem; }
    .trust-badges { display: flex; gap: 10px; justify-content: center; margin-top: 10px; font-size: 0.8em; opacity: 0.8; }
    
    .input-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; }
    .audit-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .audit-btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .audit-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .theme-toggle { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; }
    .error-banner { background: #ef4444; color: white; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .text-center { text-align: center; }
    .score-big { width: 100px; height: 100px; border-radius: 50%; margin: 15px auto; display: flex; align-items: center; justify-content: center; }
    .score-inner { width: 85px; height: 85px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; }
    
    .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .metric-item { background: var(--bg); padding: 10px; border-radius: 8px; text-align: center; }
    .metric-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
    .metric-label { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; }

    .metric-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .status-good { color: #10b981; } .status-error { color: #ef4444; }

    .tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag { background: rgba(37, 99, 235, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; }

    .rec-item { padding: 15px; margin-bottom: 10px; background: var(--card); border-left: 4px solid #ccc; border-radius: 6px; }
    .rec-critical { border-color: #ef4444; } .rec-medium { border-color: #f59e0b; }
    .rec-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: rgba(0,0,0,0.1); text-transform: uppercase; }
    .rec-fix { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }

    .action-buttons { display: flex; gap: 15px; margin-top: 30px; }
    .btn-secondary { flex: 1; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .mt-30 { margin-top: 30px; } .mt-40 { margin-top: 40px; }
    .loader { text-align: center; margin: 40px 0; }
    .loader-spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 600px) { .form-row, .grid, .metric-grid { display: block; } .input-group, .card, .metric-item { margin-bottom: 15px; } }
`
